<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>株価変動チャート</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial/dist/chartjs-chart-financial.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }

    #chart-container {
      width: 90%;
      max-width: 800px;
      margin-top: 20px;
    }

    canvas {
      width: 100%;
      height: auto;
    }
  </style>
</head>
<body>
  <h1>株価変動チャート</h1>
  <div id="chart-container">
    <canvas id="stockChart"></canvas>
  </div>
  <script>
    // クエリパラメーターから企業名を取得
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const companyName = urlParams.get('companyName');
    const apiUrl = "https://script.googleusercontent.com/macros/echo?user_content_key=k9H6PkHpMdd_hUTx3sc_ZR3UIGg5GdaqEFbpNEMnxPScYenDzsXmFStsDmta7oAY9zdJYwl4z7Uf3Lwt3AEc3nTpFgM4UO78OJmA1Yb3SEsKFZqtv3DaNYcMrmhZHmUMWojr9NvTBuBLhyHCd5hHa9iZ2UrqsNGz5NG1wsGokvbjgMWki11QBVU-i_4JSvzKLqE9G6KaWWwpS_iHTI_qznpD1-pG9aQ66d09L5B6dufr9eGNRgEtOAtBHn44AOQPmqyykG4rweN-ikh8riXu6ey_2U42-toKyua8602ukhQfqZwicMi52xeRlp9bbpE7AGG_PsK_njA2DDULVXnOAJqUnIyoTUoHTgeEpawCANNi1YnhDb42Dg&lib=ME8d0Tfb6a7zUNaTeDZ1PNbABPh_Ti3Gl";

    if (!companyName) {
      document.body.innerHTML = "<p>Error: No companyName provided in the URL. Please add ?companyName=CompanyName to the URL.</p>";
      console.error("Error: No companyName provided in the URL.");
    } else {
      // APIからデータを取得
      fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
          if (data.status === "success") {
            const stockData = data.data;

            // 最新日付を取得
            const latestDate = moment(stockData[stockData.length - 1].date);
            const oneMonthAgo = moment(latestDate).subtract(1, 'months');

            // 1ヶ月分のデータをフィルタリング
            const filteredData = stockData.filter(item => {
              const itemDate = moment(item.date);
              return itemDate.isBetween(oneMonthAgo, latestDate, 'day', '[]');
            });

            // データをChart.jsのフォーマットに変換
            const chartData = filteredData.map(item => ({
              x: item.date,
              o: item.open,
              h: item.high,
              l: item.low,
              c: item.close
            }));

            // 最大値と最小値を計算
            const allPrices = filteredData.flatMap(item => [item.high, item.low]);
            const minPrice = Math.min(...allPrices);
            const maxPrice = Math.max(...allPrices);

            // Chart.jsでチャートを描画
            const ctx = document.getElementById('stockChart').getContext('2d');
            new Chart(ctx, {
              type: 'candlestick',
              data: {
                datasets: [{
                  label: `${companyName} 株価チャート`,
                  data: chartData,
                  borderColor: '#333',
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    position: 'top'
                  },
                  tooltip: {
                    callbacks: {
                      label: (context) => {
                        const data = context.raw;
                        return [
                          `Open: ${data.o}`,
                          `High: ${data.h}`,
                          `Low: ${data.l}`,
                          `Close: ${data.c}`
                        ];
                      }
                    }
                  }
                },
                scales: {
                  x: {
                    type: 'time',
                    time: {
                      unit: 'day',
                      displayFormats: {
                        day: 'MMM DD' // 日付を表示
                      }
                    },
                    title: {
                      display: true,
                      text: 'Date'
                    }
                  },
                  y: {
                    min: minPrice * 0.95, // 最小値を少し低めに設定
                    max: maxPrice * 1.05, // 最大値を少し高めに設定
                    title: {
                      display: true,
                      text: 'Price'
                    }
                  }
                }
              }
            });
          } else {
            document.body.innerHTML = `<p>Error: ${data.message}</p>`;
            console.error("API Error:", data.message);
          }
        })
        .catch(error => {
          document.body.innerHTML = `<p>Error fetching data: ${error.message}</p>`;
          console.error("Error fetching data:", error);
        });
    }
  </script>
</body>
</html>
