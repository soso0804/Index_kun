<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Daily OHLCV Chart</title>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; background:#fff; }
    #wrap { display:flex; flex-direction:column; gap:8px; padding:8px; }
    #title { font-weight:600; padding:4px 2px; }
    #candle, #volume { width:100%; }
    #candle { height: 360px; }
    #volume { height: 140px; }
  </style>
</head>
<body>
<div id="wrap">
  <div id="title">Loading…</div>
  <div id="candle"></div>
  <div id="volume"></div>
</div>

<script>
const SUPABASE_URL = "https://<your-project-ref>.supabase.co";   // ←置き換え
const SUPABASE_ANON_KEY = "<your-anon-key>";                      // ←置き換え

// URLクエリから company / days を取得（例 ?company=KATOJI&days=120）
const params = new URLSearchParams(location.search);
const COMPANY = params.get("company") || "KATOJI";
const DAYS = Number(params.get("days") || 120);

// 直近DAYS日（JST日付ベース）
const since = new Date();
since.setDate(since.getDate() - DAYS);
const sinceStr = since.toISOString().slice(0,10); // YYYY-MM-DD

async function fetchJSON(path) {
  const r = await fetch(`${SUPABASE_URL}${path}`, {
    headers: {
      apikey: SUPABASE_ANON_KEY,
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
    }
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

(async function main() {
  document.getElementById('title').textContent =
    `${COMPANY} — Daily OHLCV (${DAYS}d)`;

  // 確定OHLCV（company_daily_ohlcv）を取得
  // ※当日をリアルタイムで見せたい場合は ohlcv_live に差し替え可
  const path =
    `/rest/v1/company_daily_ohlcv`
    + `?company_name=eq.${encodeURIComponent(COMPANY)}`
    + `&trade_date=gte.${sinceStr}`
    + `&select=trade_date,open,high,low,close,volume`
    + `&order=trade_date.asc`;
  const rows = await fetchJSON(path);

  if (!rows.length) {
    document.getElementById('title').textContent = `${COMPANY} — No data`;
    return;
  }

  // Lightweight Charts フォーマットへ変換
  // timeは 'YYYY-MM-DD' 文字列でOK
  const candles = rows.map(r => ({
    time: r.trade_date,
    open: Number(r.open),
    high: Number(r.high),
    low:  Number(r.low),
    close:Number(r.close),
  }));

  const vols = rows.map(r => {
    const o = Number(r.open), c = Number(r.close);
    return {
      time: r.trade_date,
      value: Number(r.volume || 0),
      color: c >= o ? '#26a69a' : '#ef5350', // 上昇:緑, 下落:赤
    };
  });

  // チャート（上段：ローソク）
  const candleChart = LightweightCharts.createChart(
    document.getElementById('candle'),
    {
      rightPriceScale: { borderVisible: false },
      timeScale: { borderVisible: false, timeVisible: false, secondsVisible: false },
      grid: { horzLines: { color: '#f0f3fa'}, vertLines: { color: '#f0f3fa'} },
      crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
      layout: { background: { color: '#fff' }, textColor: '#333' }
    }
  );
  const candleSeries = candleChart.addCandlestickSeries({
    upColor: '#26a69a', downColor: '#ef5350',
    wickUpColor: '#26a69a', wickDownColor: '#ef5350',
    borderUpColor: '#26a69a', borderDownColor: '#ef5350',
  });
  candleSeries.setData(candles);

  // チャート（下段：出来高）
  const volChart = LightweightCharts.createChart(
    document.getElementById('volume'),
    {
      rightPriceScale: { borderVisible: false },
      timeScale: { borderVisible: true, timeVisible: true, secondsVisible: false },
      grid: { horzLines: { color: '#f0f3fa'}, vertLines: { color: '#f0f3fa'} },
      crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
      layout: { background: { color: '#fff' }, textColor: '#333' }
    }
  );
  const volSeries = volChart.addHistogramSeries({ priceFormat: { type: 'volume' } });
  volSeries.setData(vols);

  // 上下のスクロール・ズームをある程度同期
  function syncTimescale(master, slave) {
    master.timeScale().subscribeVisibleTimeRangeChange((range) => {
      if (!range) return;
      const r = slave.timeScale().getVisibleRange();
      if (!r || r.from !== range.from || r.to !== range.to) {
        slave.timeScale().setVisibleRange(range);
      }
    });
  }
  syncTimescale(candleChart, volChart);
  syncTimescale(volChart, candleChart);

  // リサイズ対応
  const resize = () => {
    const w = document.getElementById('wrap').clientWidth;
    candleChart.applyOptions({ width: w });
    volChart.applyOptions({ width: w });
  };
  window.addEventListener('resize', resize);
  resize();
})();
</script>
</body>
</html>
