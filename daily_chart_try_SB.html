<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>チャート</title>
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<style>
:root{
  --bg:#0b0e11;
  --card:#11151a;
  --text:#e8eef5;
  --muted:#9fb3c8;
  --grid:#1b222b;
  --up:#26a69a;
  --down:#ef5350;
  --accent:#5b9bff;
  --vol:#f6c945;
}
body.light{
  --bg:#f7f9fb;
  --card:#ffffff;
  --text:#18212f;
  --muted:#55697e;
  --grid:#e9eef5;
}
*{ box-sizing:border-box; }
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Yu Gothic",sans-serif;
  touch-action:manipulation;
}
.wrapper{
  display:flex;
  flex-direction:column;
  height:100vh;
  width:100%;
}
.header{
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:flex-end;
  padding:8px 10px;
  background:var(--card);
  border-bottom:1px solid rgba(255,255,255,.08);
}
.header select,.header button{
  background:transparent;
  color:var(--text);
  border:1px solid rgba(255,255,255,.2);
  padding:6px 10px;
  border-radius:8px;
  font-size:14px;
}
.header button.active{
  background:var(--accent);
  color:#fff;
  border-color:var(--accent);
}
.chart-area{
  flex:1;
  display:flex;
  flex-direction:column;
  padding:0 6px 2px 6px;
}
#candle{ flex:4; width:100%; }
#volume{ flex:1.2; width:100%; }
.footer{
  background:var(--card);
  border-top:1px solid rgba(255,255,255,.08);
  padding:6px 10px;
}
.legend{
  font-size:11px;
  color:var(--muted);
  display:flex;
  gap:12px;
  align-items:center;
  flex-wrap:wrap;
  justify-content:center;
}
.dot{
  width:8px;
  height:8px;
  border-radius:50%;
  display:inline-block;
  margin-right:6px;
}
.tooltip{
  position:absolute;
  pointer-events:none;
  background:rgba(0,0,0,.7);
  color:#fff;
  font-size:11px;
  padding:6px 8px;
  border-radius:6px;
  white-space:nowrap;
  z-index:10;
  transform:translate(-50%,-120%);
}
.hidden{ display:none; }
</style>
</head>
<body class="light">
<div class="wrapper">
  <div class="header">
    <select id="period">
      <option value="7">1週間</option>
      <option value="30">1ヶ月</option>
      <option value="180" selected>半年</option>
      <option value="365">1年</option>
    </select>
    <button id="toggle-perc">％</button>
    <button id="toggle-theme">☀️</button>
  </div>

  <div class="chart-area" id="chart-wrap">
    <div id="candle"></div>
    <div id="volume"></div>
    <div class="tooltip hidden" id="tooltip"></div>
  </div>

  <div class="footer">
    <div class="legend">
      <span><span class="dot" style="background:#5b9bff"></span>MA5</span>
      <span><span class="dot" style="background:#c084fc"></span>MA25</span>
      <span><span class="dot" style="background:#f6c945"></span>出来高</span>
    </div>
  </div>
</div>

<script>
/* ===== Supabase設定 ===== */
const SUPABASE_URL = "https://ddtszhkycoqnffgciucl.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkdHN6aGt5Y29xbmZmZ2NpdWNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwMDExODQsImV4cCI6MjA2NDU3NzE4NH0.hASl_SDEf86hISajh9WQ0o5kVTuWZCV7IJ7y363cN9c";

/* ===== URLパラメータ ===== */
const q = new URLSearchParams(location.search);
const COMPANY = q.get("company") || "KATOJI";
const SRC = (q.get("src") || "fixed").toLowerCase();   // fixed | live
let days = Number(q.get("days") || 180);

/* ===== ユーティリティ（JST / ローカル日付で扱う） ===== */
function toLocalDateString(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}

function since(d){
  const s = new Date();
  s.setDate(s.getDate() - d);
  return toLocalDateString(s);            // ★ ローカル日付
}
function todayISO(){
  return toLocalDateString(new Date());   // ★ ローカル日付（JST の今日）
}

async function fetchJSON(path){
  const r = await fetch(SUPABASE_URL + path, {
    headers:{
      apikey: SUPABASE_KEY,
      Authorization: "Bearer " + SUPABASE_KEY
    }
  });
  if(!r.ok){
    throw new Error(await r.text());
  }
  return r.json();
}
function hashSeed(str){
  let h = 2166136261;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h += (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24);
  }
  return Math.abs(h % 100000);
}
function prng(seed){
  return function(){
    seed = Math.sin(seed) * 10000;
    return seed - Math.floor(seed);
  };
}
function stdev(a){
  if(a.length < 2) return 0.02;
  const m = a.reduce((x,y)=>x+y,0) / a.length;
  const v = a.reduce((x,y)=>x + (y-m)*(y-m),0) / (a.length-1);
  return Math.sqrt(v);
}

/* SB実データの水準・ボラに似せたモックを days 分作成（ローソク幅をやや小さめに調整） */
function makeMockLikeSB(days, sbRows, seed){
  const closes = sbRows.map(r => +r.close);
  const vols   = sbRows.map(r => +(r.volume || 0));
  const rets = [];
  for(let i=1;i<closes.length;i++){
    rets.push((closes[i]-closes[i-1]) / Math.max(1e-9, closes[i-1]));
  }
  const sigma = Math.max(0.01, Math.min(0.15, stdev(rets) || 0.03));
  let px  = closes.length ? closes[closes.length-1] : 10000;
  let vol = vols.length
    ? vols.slice(-Math.min(vols.length,10)).reduce((a,b)=>a+b,0) / Math.min(vols.length,10)
    : 20000;

  const rnd  = prng(seed);
  const base = new Date();
  base.setDate(base.getDate() - days);
  const out = [];

  for(let i=0;i<days;i++){
    const d = new Date(base);
    d.setDate(base.getDate() + i + 1);
    const day = toLocalDateString(d);   // ★ ローカル日付

    const u = Math.max(1e-6, rnd());
    const v = Math.max(1e-6, rnd());
    const z = Math.sqrt(-2*Math.log(u)) * Math.cos(2*Math.PI*v);

    const ret   = z * sigma * 0.45;      // ← 変動を少し小さめに
    const open  = px;
    const close = Math.max(50, open*(1+ret));

    // ← ヒゲの幅も控えめに
    const rangeBase  = Math.max(open*0.002, Math.abs(ret)*open*1.2);
    const intraNoise = 150 + 350*rnd();
    const range = rangeBase + intraNoise;

    const high = Math.max(open, close) + range*0.25*rnd();
    const low  = Math.min(open, close)  - range*0.25*rnd();

    px  = close;
    vol = Math.max(1000, vol*(0.9 + 0.2*rnd()));

    out.push({
      trade_date: day,
      open:  +open.toFixed(2),
      high:  +high.toFixed(2),
      low:   +low.toFixed(2),
      close: +close.toFixed(2),
      volume: Math.round(vol)
    });
  }
  return out;
}

/* 連続した日付配列を作り、SBが無い日はモックで補完。
   当日分だけは company_daily_price から取得して上書き。 */
async function getRows(days){
  const sinceStr = since(days);
  const table = SRC === "live" ? "company_daily_ohlcv_live" : "company_daily_ohlcv";

  let sb = [];
  try{
    sb = await fetchJSON(
      `/rest/v1/${table}?company_name=eq.${encodeURIComponent(COMPANY)}` +
      `&trade_date=gte.${sinceStr}` +
      `&select=trade_date,open,high,low,close,volume&order=trade_date.asc`
    );
  }catch(e){
    console.error("ohlcv fetch error", e);
  }

  // 当日の終値（点）だけ company_daily_price から取ってくる
  try{
    const tStr = todayISO();
    const pr = await fetchJSON(
      `/rest/v1/company_daily_price?company_name=eq.${encodeURIComponent(COMPANY)}` +
      `&trade_date=eq.${tStr}` +
      `&select=trade_date,current_price,start_price,max_price,min_price,end_price&limit=1`
    );
    if(pr && pr.length){
      const p = pr[0];
      const price = Number(p.current_price ?? p.end_price);
      const o = Number(p.start_price ?? price);
      const h = Number(p.max_price ?? price);
      const l = Number(p.min_price ?? price);
      const todayRow = {
        trade_date: p.trade_date,
        open:  isNaN(o) ? price : o,
        high:  isNaN(h) ? price : h,
        low:   isNaN(l) ? price : l,
        close: price,
        volume: 0,
        _fromPrice: true
