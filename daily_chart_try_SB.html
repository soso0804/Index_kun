<script>
/* ===== Supabaseè¨­å®š ===== */
const SUPABASE_URL="https://ddtszhkycoqnffgciucl.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkdHN6aGt5Y29xbmZmZ2NpdWNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwMDExODQsImV4cCI6MjA2NDU3NzE4NH0.hASl_SDEf86hISajh9WQ0o5kVTuWZCV7IJ7y363cN9c";

/* ===== URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ===== */
const q=new URLSearchParams(location.search);
const COMPANY=q.get('company')||'KATOJI';
const SRC=(q.get('src')||'fixed').toLowerCase();   // fixed | live
let days=Number(q.get('days')||180);

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const since=(d)=>{const s=new Date(); s.setDate(s.getDate()-d); return s.toISOString().slice(0,10);}
const todayISO = ()=> new Date().toISOString().slice(0,10);   // â˜… ä»Šæ—¥(UTC)ã‚’ date æ–‡å­—åˆ—ã§

async function fetchJSON(path){
  const r=await fetch(`${SUPABASE_URL}${path}`,{
    headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
function hashSeed(str){ let h=2166136261; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h+=(h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24);} return Math.abs(h%100000); }
function prng(seed){ return ()=>{ seed=Math.sin(seed)*10000; return seed-Math.floor(seed); }; }
function stdev(a){
  if(a.length<2) return 0.02;
  const m=a.reduce((x,y)=>x+y,0)/a.length;
  const v=a.reduce((x,y)=>x+(y-m)**2,0)/(a.length-1);
  return Math.sqrt(v);
}

/* SBå®Ÿãƒ‡ãƒ¼ã‚¿ã®æ°´æº–ãƒ»ãƒœãƒ©ã«ä¼¼ã›ãŸãƒ¢ãƒƒã‚¯ã‚’ days åˆ†ä½œæˆï¼ˆãƒ­ãƒ¼ã‚½ã‚¯å¹…ã‚’ã‚„ã‚„å°ã•ã‚ã«èª¿æ•´ï¼‰ */
function makeMockLikeSB(days, sbRows, seed){
  const closes=sbRows.map(r=>+r.close);
  const vols=sbRows.map(r=>+(r.volume||0));
  const rets=[];
  for(let i=1;i<closes.length;i++){
    rets.push((closes[i]-closes[i-1])/Math.max(1e-9,closes[i-1]));
  }
  const sigma=Math.max(0.01, Math.min(0.15, stdev(rets)||0.03));
  let px=closes.length? closes.at(-1) : 10000;
  let vol=vols.length? vols.slice(-Math.min(vols.length,10)).reduce((a,b)=>a+b,0)/Math.min(vols.length,10) : 20000;

  const rnd=prng(seed);
  const base=new Date(); base.setDate(base.getDate()-days);
  const out=[];
  for(let i=0;i<days;i++){
    const d=new Date(base); d.setDate(base.getDate()+i+1);
    const day=d.toISOString().slice(0,10);

    const u=Math.max(1e-6, rnd()), v=Math.max(1e-6, rnd());
    const z=Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
    const ret=z*sigma*0.45;                     // â˜… ä»¥å‰ã‚ˆã‚Šå°‘ã—å°ã•ã‚ã®å¤‰å‹•
    const open=px;
    const close=Math.max(50, open*(1+ret));

    // â˜… é«˜å€¤ãƒ»å®‰å€¤ã®ãƒ¬ãƒ³ã‚¸ã‚‚å°ã•ã‚ã«
    const rangeBase = Math.max(open*0.002, Math.abs(ret)*open*1.2);
    const intraNoise = 150 + 350*rnd();
    const range = rangeBase + intraNoise;
    const high=Math.max(open,close) + range*0.25*rnd();
    const low =Math.min(open,close)  - range*0.25*rnd();

    px=close;
    vol=Math.max(1000, vol*(0.9+0.2*rnd()));
    out.push({
      trade_date:day,
      open:+open.toFixed(2),
      high:+high.toFixed(2),
      low:+low.toFixed(2),
      close:+close.toFixed(2),
      volume:Math.round(vol)
    });
  }
  return out;
}

/* é€£ç¶šã—ãŸæ—¥ä»˜é…åˆ—ã‚’ä½œã‚Šã€SBãŒç„¡ã„æ—¥ã¯ãƒ¢ãƒƒã‚¯ã§è£œå®Œã€‚
   å½“æ—¥åˆ†ã ã‘ã¯ company_daily_price ã‹ã‚‰å–å¾—ã—ã¦ä¸Šæ›¸ãã€‚ */
async function getRows(days){
  const sinceStr=since(days);
  const table= SRC==='live' ? 'company_daily_ohlcv_live' : 'company_daily_ohlcv';

  let sb=[];
  try{
    sb = await fetchJSON(
      `/rest/v1/${table}?company_name=eq.${encodeURIComponent(COMPANY)}` +
      `&trade_date=gte.${sinceStr}` +
      `&select=trade_date,open,high,low,close,volume&order=trade_date.asc`
    );
  }catch(e){ console.error(e); }

  // â˜… å½“æ—¥ã®çµ‚å€¤ï¼ˆç‚¹ï¼‰ã ã‘ company_daily_price ã‹ã‚‰å–ã£ã¦ãã‚‹
  let todayRow = null;
  try{
    const tStr = todayISO();
    const pr = await fetchJSON(
      `/rest/v1/company_daily_price?company_name=eq.${encodeURIComponent(COMPANY)}` +
      `&trade_date=eq.${tStr}` +
      `&select=trade_date,current_price,start_price,max_price,min_price,end_price&limit=1`
    );
    if(pr && pr.length){
      const p = pr[0];
      const price = Number(p.current_price ?? p.end_price);
      const o = Number(p.start_price ?? price);
      const h = Number(p.max_price ?? price);
      const l = Number(p.min_price ?? price);
      todayRow = {
        trade_date: p.trade_date,
        open: isNaN(o)? price : o,
        high: isNaN(h)? price : h,
        low : isNaN(l)? price : l,
        close: price,
        volume: 0,           // å‡ºæ¥é«˜ã¯ä¸æ˜ãªã®ã§ 0 ã§ OK
        _fromPrice: true     // ï¼ˆå¿…è¦ãªã‚‰ã‚¹ã‚¿ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆã«ä½¿ãˆã‚‹ãƒ•ãƒ©ã‚°ï¼‰
      };

      // æ—¢ã« OHLVC ã«ä»Šæ—¥ãŒã‚ã‚Œã°ä¸Šæ›¸ãã€ãªã‘ã‚Œã°è¿½åŠ 
      const idx = sb.findIndex(r => r.trade_date === p.trade_date);
      if(idx >= 0) sb[idx] = todayRow;
      else { sb.push(todayRow); sb.sort((a,b)=>a.trade_date.localeCompare(b.trade_date)); }
    }
  }catch(e){ console.error(e); }

  // è¦æ±‚æœŸé–“åˆ†ã®é€£ç¶šæ—¥ä»˜ã‚’ä½œã‚‹ï¼ˆæœ€å¾Œã¯ä»Šæ—¥ï¼‰
  const dayList=[];
  const s=new Date(); s.setDate(s.getDate()-days);
  for(let i=0;i<days;i++){
    const d=new Date(s); d.setDate(s.getDate()+i+1);
    dayList.push(d.toISOString().slice(0,10));
  }

  const seed=hashSeed(COMPANY);
  const mock=makeMockLikeSB(days, sb, seed);
  const map=new Map(sb.map(r=>[r.trade_date, r]));

  const merged = dayList.map(d => {
    // OHLVC or å½“æ—¥ä¾¡æ ¼ã®å®Ÿãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã„ã€ç„¡ã‘ã‚Œã°ãƒ¢ãƒƒã‚¯ã§è£œå®Œ
    return map.get(d) || mock.find(m=>m.trade_date===d);
  });

  return merged.filter(Boolean);
}

/* ===== æç”» ===== */
let priceMode='abs', theme='light';
let candleChart,volChart,candleSeries,volSeries,ma5Series,ma25Series;
function movingAverage(rows,n){
  const out=[]; let sum=0,buf=[];
  for(const r of rows){
    const c=+r.close;
    buf.push(c); sum+=c;
    if(buf.length>n) sum-=buf.shift();
    out.push({time:r.trade_date,value:buf.length===n?+(sum/n).toFixed(2):NaN});
  }
  return out;
}

function draw(rows){
  const wrap=document.getElementById('chart-wrap');
  wrap.innerHTML=`<div id="candle"></div><div id="volume"></div><div class="tooltip hidden" id="tooltip"></div>`;
  const cs=getComputedStyle(document.body),
        bg=cs.getPropertyValue('--bg').trim(),
        tx=cs.getPropertyValue('--text').trim(),
        grid=cs.getPropertyValue('--grid').trim();

  candleChart=LightweightCharts.createChart(document.getElementById('candle'),{
    layout:{background:{color:bg},textColor:tx},
    rightPriceScale:{autoScale:true},
    timeScale:{timeVisible:true,borderVisible:false},
    grid:{horzLines:{color:grid},vertLines:{color:grid}},
    handleScroll:{mouseWheel:true,pressedMouseMove:true},
    handleScale:{axisPressedMouseMove:true,pinch:true},
    autoSize:true,
  });
  candleSeries=candleChart.addCandlestickSeries({
    upColor:'#26a69a',
    downColor:'#ef5350',
    borderUpColor:'#26a69a',
    borderDownColor:'#ef5350',
    wickUpColor:'#26a69a',
    wickDownColor:'#ef5350'
  });

  volChart=LightweightCharts.createChart(document.getElementById('volume'),{
    layout:{background:{color:bg},textColor:tx},
    rightPriceScale:{autoScale:true},
    timeScale:{visible:true},
    grid:{horzLines:{color:grid},vertLines:{color:grid}},
    handleScroll:{mouseWheel:true,pressedMouseMove:true},
    handleScale:{axisPressedMouseMove:true,pinch:true},
    autoSize:true
  });
  volSeries=volChart.addHistogramSeries({
    color:getComputedStyle(document.documentElement).getPropertyValue('--vol').trim(),
    priceFormat:{type:'volume'}
  });

  const candles=rows.map(r=>({
    time:r.trade_date,
    open:+r.open,
    high:+r.high,
    low:+r.low,
    close:+r.close
  }));
  const vols = rows.map(r=>({time:r.trade_date, value:+(r.volume||0)}));

  candleSeries.setData(candles);
  volSeries.setData(vols);

  ma5Series=candleChart.addLineSeries({color:'#5b9bff',lineWidth:2,priceLineVisible:false});
  ma5Series.setData(movingAverage(rows,5));
  ma25Series=candleChart.addLineSeries({color:'#c084fc',lineWidth:2,priceLineVisible:false});
  ma25Series.setData(movingAverage(rows,25));

  candleChart.priceScale('right').applyOptions({
    mode: priceMode==='pct'
      ? LightweightCharts.PriceScaleMode.Percentage
      : LightweightCharts.PriceScaleMode.Normal,
    autoScale:true
  });

  const N=rows.length;
  const logical={from:0, to:Math.max(1, N-1)};
  candleChart.timeScale().setVisibleLogicalRange(logical);
  volChart.timeScale().setVisibleLogicalRange(logical);

  let syncing=false;
  function bind(a,b){
    a.timeScale().subscribeVisibleTimeRangeChange(r=>{
      if(syncing||!r) return;
      syncing=true; b.timeScale().setVisibleRange(r); syncing=false;
    });
    a.timeScale().subscribeVisibleLogicalRangeChange(r=>{
      if(syncing||!r) return;
      syncing=true; b.timeScale().setVisibleLogicalRange(r); syncing=false;
    });
  }
  bind(candleChart, volChart); bind(volChart, candleChart);
}

/* ===== èµ·å‹• & UI ===== */
let currentRows=[];
(async function init(){
  const sel=document.getElementById('period');
  if([...sel.options].some(o=>+o.value===days)) sel.value=String(days);

  currentRows = await getRows(days);
  draw(currentRows);

  sel.onchange = async (e)=>{
    days=+e.target.value;
    const u=new URL(location.href);
    u.searchParams.set('days',days);
    history.replaceState(null,'',u);
    currentRows = await getRows(days);
    draw(currentRows);
  };

  const percBtn=document.getElementById('toggle-perc');
  const setPercUI=()=>percBtn.classList.toggle('active', priceMode==='pct');
  percBtn.onclick=()=>{
    priceMode=(priceMode==='pct'?'abs':'pct');
    setPercUI();
    draw(currentRows);
  };
  setPercUI();

  const themeBtn=document.getElementById('toggle-theme');
  themeBtn.onclick=()=>{
    document.body.classList.toggle('light');
    themeBtn.textContent = document.body.classList.contains('light') ? 'â˜€ï¸' : 'ğŸŒ™';
    draw(currentRows);
  };
})();
</script>
