<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Daily OHLCV Chart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Lightweight Charts v4 (Âõ∫ÂÆö) -->
  <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root{
      --bg:#0b0e11; --card:#11151a; --text:#e8eef5; --muted:#9fb3c8; --grid:#1b222b;
      --up:#26a69a; --down:#ef5350; --accent:#5b9bff;
      --shadow: 0 8px 30px rgba(0,0,0,.25);
    }
    body.light{ --bg:#f6f8fb; --card:#ffffff; --text:#18212f; --muted:#55697e; --grid:#e9eef5; --shadow:0 8px 30px rgba(31,59,95,.08); }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, Arial, sans-serif;}
    .container{ max-width:1100px; margin:24px auto; padding:0 12px; }
    .card{ background:var(--card); border-radius:18px; box-shadow:var(--shadow); overflow:hidden; border:1px solid rgba(255,255,255,.06); }
    .header{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; gap:12px; border-bottom:1px solid rgba(255,255,255,.08); }
    .title{ font-size:18px; font-weight:700; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .btn{ appearance:none; border:1px solid rgba(255,255,255,.12); color:var(--text); background:transparent; padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.active{ border-color:var(--accent); color:#fff; background:var(--accent); }
    .btn.ghost{ border-color:rgba(255,255,255,.18); }
    .wrap-charts{ display:flex; flex-direction:column; gap:6px; padding:10px; }
    #candle{ height:420px; width:100%; }
    #volume{ height:140px; width:100%; }
    .footer{ padding:10px 14px; color:var(--muted); font-size:12px; display:flex; justify-content:space-between; align-items:center; gap:8px; border-top:1px solid rgba(255,255,255,.08); }
    .tooltip{ position:absolute; pointer-events:none; background:rgba(14,18,22,.9); color:#eef4ff; padding:8px 10px; border-radius:10px; font-size:12px; box-shadow:0 6px 16px rgba(0,0,0,.35); transform:translate(-50%,-120%); white-space:nowrap; z-index:5; }
    body.light .tooltip{ background:#121a22; color:#f2f6fc; }
    .legend{ font-size:12px; color:var(--muted); display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; vertical-align:middle; margin-right:6px; }
    .hidden{ display:none; }
    a, a:visited{ color:var(--muted); text-decoration:none; }
  </style>
</head>
<body class="light">
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title" id="title">Loading‚Ä¶</div>
        <div class="toolbar">
          <button class="btn" data-days="30">30Êó•</button>
          <button class="btn active" data-days="90">90Êó•</button>
          <button class="btn" data-days="180">180Êó•</button>
          <button class="btn" data-days="365">1Âπ¥</button>
          <button class="btn ghost" id="toggle-theme">üåó „ÉÜ„Éº„Éû</button>
        </div>
      </div>
      <div class="wrap-charts" id="chart-wrap">
        <div id="candle"></div>
        <div id="volume"></div>
        <div class="tooltip hidden" id="tooltip"></div>
      </div>
      <div class="footer">
        <div class="legend">
          <span><span class="dot" style="background:#26a69a"></span>‰∏äÊòá</span>
          <span><span class="dot" style="background:#ef5350"></span>‰∏ãËêΩ</span>
          <span><span class="dot" style="background:#5b9bff"></span>MA5</span>
          <span><span class="dot" style="background:#c084fc"></span>MA25</span>
        </div>
        <div id="hint">Tips: `?mock=1` „Åß„É¢„ÉÉ„ÇØ„Éá„Éº„ÇøË°®Á§∫</div>
      </div>
    </div>
  </div>

<script>
/* === Ë®≠ÂÆöÔºà„ÅÇ„Å™„Åü„ÅÆÂÄ§„Å´ÁΩÆ„ÅçÊèõ„ÅàÊ∏à„ÅøÔºâ === */
const SUPABASE_URL = "https://ddtszhkycoqnffgciucl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkdHN6aGt5Y29xbmZmZ2NpdWNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwMDExODQsImV4cCI6MjA2NDU3NzE4NH0.hASl_SDEf86hISajh9WQ0o5kVTuWZCV7IJ7y363cN9c";

/* === URL „Éë„É©„É°„Éº„Çø === */
const params  = new URLSearchParams(location.search);
const COMPANY = params.get("company") || "KATOJI";
const src     = (params.get("src") || "fixed").toLowerCase(); // 'fixed' | 'live'
const FORCE_MOCK = params.get("mock") === "1";
const DAYS_BTN_DEFAULT = Number(params.get("days") || 90);

/* === „ÉÑ„Éº„É´Èñ¢Êï∞ === */
const fmtDate = d => new Date(d).toLocaleDateString('ja-JP', {year:'numeric', month:'2digit', day:'2digit'});
const sinceFromDays = (days) => {
  const s = new Date(); s.setDate(s.getDate() - days);
  return s.toISOString().slice(0,10);
}

/* === Supabase REST === */
async function fetchJSON(path) {
  const r = await fetch(`${SUPABASE_URL}${path}`, {
    headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` }
  });
  if (!r.ok) throw new Error(`HTTP ${r.status} ${r.statusText}: ${await r.text()}`);
  return r.json();
}

/* === „É¢„ÉÉ„ÇØ„Éá„Éº„ÇøÔºàÊ≠©Áïô„Çä„É©„É≥„ÉÄ„É†„Ç¶„Ç©„Éº„ÇØÔºâ === */
function makeMock(days=180, seed=42){
  const rand = (function(s){ return ()=> (s=Math.sin(s)*10000, s-Math.floor(s)); })(seed);
  const start = 8000 + Math.round(rand()*6000);
  let px = start, vol = 200000;
  const data = [];
  const base = new Date(); base.setDate(base.getDate() - days);
  for(let i=0;i<days;i++){
    const d = new Date(base); d.setDate(base.getDate()+i+1);
    const day = d.toISOString().slice(0,10);
    const drift = (rand()-.5)*400;                 // Êó•„Åî„Å®„ÅÆ„Éâ„É™„Éï„Éà
    const range = 300 + rand()*1200;               // Êó•‰∏≠ÂÄ§ÂπÖ
    const open  = Math.max(100, px + drift);
    const high  = open + range*rand();
    const low   = open - range*(0.3+rand()*0.7);
    const close = low + (high-low)*rand();
    px = close;
    vol = Math.max(8000, vol*(0.7+rand()*0.8));
    data.push({
      trade_date: day,
      open: +open.toFixed(2),
      high: +high.toFixed(2),
      low:  +low.toFixed(2),
      close:+close.toFixed(2),
      volume: Math.round(vol)
    });
  }
  return data;
}

/* === ÁßªÂãïÂπ≥Âùá === */
function movingAverage(rows, period){
  const out = [];
  let sum = 0, q = [];
  for(const r of rows){
    q.push(r.close); sum += r.close;
    if(q.length > period){ sum -= q.shift(); }
    if(q.length === period){
      out.push({ time: r.trade_date, value: +(sum/period).toFixed(2) });
    } else {
      out.push({ time: r.trade_date, value: NaN }); // ÂâçÂçä„ÅØÊ¨†ÊêçË°®Á§∫Ôºà„ÇÆ„É£„ÉÉ„ÉóÔºâ
    }
  }
  return out;
}

/* === „É°„Ç§„É≥ === */
(async function main(){
  // „ÉÑ„Éº„É´„Éê„Éº„ÅÆÂàùÊúüÈÅ∏Êäû
  [...document.querySelectorAll('.btn[data-days]')].forEach(b=>{
    b.classList.toggle('active', Number(b.dataset.days)===DAYS_BTN_DEFAULT);
    b.addEventListener('click', ()=>{
      const days = Number(b.dataset.days);
      const url = new URL(location.href);
      url.searchParams.set('days', days);
      history.replaceState(null, '', url);
      location.reload();
    });
  });
  document.getElementById('toggle-theme').onclick = ()=>{
    document.body.classList.toggle('light');
  };

  const days = Number(new URLSearchParams(location.search).get('days') || DAYS_BTN_DEFAULT);
  const sinceStr = sinceFromDays(days);

  // „Çø„Ç§„Éà„É´
  document.getElementById('title').textContent =
    `${COMPANY} ‚Äî Daily OHLCV (${days}d) ${src==='live'?'[LIVE]':''}`;

  // „Éá„Éº„ÇøÂèñÂæó
  let rows = [];
  if (!FORCE_MOCK) {
    const table = src === 'live' ? 'company_daily_ohlcv_live' : 'company_daily_ohlcv';
    const path =
      `/rest/v1/${table}`
      + `?company_name=eq.${encodeURIComponent(COMPANY)}`
      + `&trade_date=gte.${sinceStr}`
      + `&select=trade_date,open,high,low,close,volume`
      + `&order=trade_date.asc`;
    try{
      rows = await fetchJSON(path);
    }catch(e){
      console.error(e);
    }
  }
  // „Éá„Éº„Çø„ÅåÂ∞ë„Å™„Åë„Çå„Å∞„É¢„ÉÉ„ÇØ„ÅßÁΩÆ„ÅçÊèõ„ÅàÔºà2Êú¨‰ª•‰∏ã or mock=1Ôºâ
  if (FORCE_MOCK || !rows || rows.length <= 2) {
    rows = makeMock(days);
    document.getElementById('hint').innerHTML = 'Mock modeÔºà„Éá„Éº„Çø„ÅåÂ∞ë„Å™„ÅÑ„Åü„ÇÅ‰ªÆ„Éá„Éº„ÇøË°®Á§∫‰∏≠Ôºâ';
  } else {
    document.getElementById('hint').innerHTML =
      `ÊúüÈñì: ${fmtDate(sinceStr)} „Äú ${fmtDate(rows.at(-1).trade_date)} / ‰ª∂Êï∞: ${rows.length}`;
  }

  // Ëª¢ÊèõÔºöLightweight Charts Áî®„Éá„Éº„Çø
  const candles = rows.map(r => ({ time:r.trade_date, open:+r.open, high:+r.high, low:+r.low, close:+r.close }));
  const vols = rows.map(r => {
    const o = +r.open, c = +r.close;
    return { time:r.trade_date, value:+(r.volume||0), color: c>=o ? '#26a69a' : '#ef5350' };
  });
  const ma5  = movingAverage(rows, 5);
  const ma25 = movingAverage(rows, 25);

  // „ÉÅ„É£„Éº„Éà‰ΩúÊàê
  const candleEl = document.getElementById('candle');
  const volEl    = document.getElementById('volume');
  const tooltip  = document.getElementById('tooltip');

  const candleChart = LightweightCharts.createChart(candleEl, {
    layout: { background: { color: getComputedStyle(document.body).getPropertyValue('--card').trim() }, textColor: getComputedStyle(document.body).getPropertyValue('--text').trim() },
    rightPriceScale:{ borderVisible:false },
    timeScale:{ borderVisible:false, timeVisible:false, secondsVisible:false },
    grid:{ horzLines:{ color:getComputedStyle(document.body).getPropertyValue('--grid').trim() }, vertLines:{ color:getComputedStyle(document.body).getPropertyValue('--grid').trim() } },
    localization:{ locale:'ja-JP' },
    handleScroll:{ mouseWheel:true, pressedMouseMove:true },
    handleScale:{ axisPressedMouseMove:true, pinch:true },
    autoSize:true,
    watermark:{ visible:true, text: COMPANY, fontSize: 18, color:'rgba(120,140,160,.25)' }
  });
  const candleSeries = candleChart.addCandlestickSeries({
    upColor:'#26a69a', downColor:'#ef5350',
    wickUpColor:'#26a69a', wickDownColor:'#ef5350',
    borderUpColor:'#26a69a', borderDownColor:'#ef5350',
    priceLineVisible:true
  });
  candleSeries.setData(candles);

  const ma5Series = candleChart.addLineSeries({ color:'#5b9bff', lineWidth:2, priceLineVisible:false });
  const ma25Series= candleChart.addLineSeries({ color:'#c084fc', lineWidth:2, priceLineVisible:false });
  ma5Series.setData(ma5);
  ma25Series.setData(ma25);

  const volChart = LightweightCharts.createChart(volEl, {
    layout: { background: { color: getComputedStyle(document.body).getPropertyValue('--card').trim() }, textColor: getComputedStyle(document.body).getPropertyValue('--text').trim() },
    rightPriceScale:{ borderVisible:false },
    timeScale:{ borderVisible:true, timeVisible:true, secondsVisible:false },
    grid:{ horzLines:{ color:getComputedStyle(document.body).getPropertyValue('--grid').trim() }, vertLines:{ color:getComputedStyle(document.body).getPropertyValue('--grid').trim() } },
    localization:{ locale:'ja-JP' },
    handleScroll:{ mouseWheel:true, pressedMouseMove:true },
    handleScale:{ axisPressedMouseMove:true, pinch:true },
    autoSize:true,
  });
  const volSeries = volChart.addHistogramSeries({ priceFormat:{ type:'volume' }, baseLineVisible:false });
  volSeries.setData(vols);

  // ÂèØË¶ñÁØÑÂõ≤„ÇíÂØÑ„Åõ„Çã
  candleChart.timeScale().fitContent();
  volChart.timeScale().fitContent();

  // „Çπ„ÇØ„É≠„Éº„É´ÂêåÊúü
  function syncTimescale(master, slave){
    master.timeScale().subscribeVisibleTimeRangeChange((range)=>{
      if(!range) return;
      const r = slave.timeScale().getVisibleRange();
      if(!r || r.from!==range.from || r.to!==range.to){
        slave.timeScale().setVisibleRange(range);
      }
    });
  }
  syncTimescale(candleChart, volChart); syncTimescale(volChart, candleChart);

  // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÔºàÂçÅÂ≠óÁ∑ö„Å´ËøΩÂæìÔºâ
  candleChart.subscribeCrosshairMove(param=>{
    if(!param || !param.time || !param.point) { tooltip.classList.add('hidden'); return; }
    const t = param.time; // business day string
    const c = param.seriesData.get(candleSeries);
    const m5  = param.seriesData.get(ma5Series);
    const m25 = param.seriesData.get(ma25Series);
    const v   = param.seriesData.get(volSeries);

    if(!c){ tooltip.classList.add('hidden'); return; }

    tooltip.classList.remove('hidden');
    tooltip.innerHTML =
      `<b>${t}</b><br>`+
      `O: ${c.open.toLocaleString()} H: ${c.high.toLocaleString()} L: ${c.low.toLocaleString()} C: ${c.close.toLocaleString()}<br>`+
      `V: ${(v?.value||0).toLocaleString()}  `+
      `<span style="color:#5b9bff">MA5: ${isFinite(m5?.value)?m5.value.toFixed(2):'-'}</span>  `+
      `<span style="color:#c084fc">MA25: ${isFinite(m25?.value)?m25.value.toFixed(2):'-'}</span>`;

    const wrap = document.getElementById('chart-wrap').getBoundingClientRect();
    const x = param.point.x + wrap.left;
    const y = param.point.y + wrap.top;
    tooltip.style.left = `${x}px`;
    tooltip.style.top  = `${y}px`;
  });

  // „É™„Çµ„Ç§„Ç∫ÂØæÂøúÔºàautoSize=true„Åß„ÇÇË¶™„ÅÆ„Éë„Éá„Ç£„É≥„Ç∞Â§âÊõ¥„ÅßÂÜçÈÅ©Áî®Ôºâ
  const resize = ()=>{ candleChart.resize(candleEl.clientWidth, candleEl.clientHeight); volChart.resize(volEl.clientWidth, volEl.clientHeight); };
  window.addEventListener('resize', resize);

})();
</script>
</body>
</html>
