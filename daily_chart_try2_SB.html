<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>„ÉÅ„É£„Éº„Éà</title>
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<style>
:root{ --bg:#0b0e11; --card:#11151a; --text:#e8eef5; --muted:#9fb3c8; --grid:#1b222b; --up:#26a69a; --down:#ef5350; --accent:#5b9bff; --vol:#f6c945; }
body.light{ --bg:#f7f9fb; --card:#ffffff; --text:#18212f; --muted:#55697e; --grid:#e9eef5; }
*{ box-sizing:border-box; }
body{ margin:0; background:var(--bg); color:var(--text); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Yu Gothic",sans-serif; touch-action:manipulation; }
.wrapper{ display:flex; flex-direction:column; height:100vh; width:100%; }
.header{ display:flex; gap:8px; align-items:center; justify-content:flex-end; padding:8px 10px; background:var(--card); border-bottom:1px solid rgba(255,255,255,.08); }
.header select,.header button{ background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.2); padding:6px 10px; border-radius:8px; font-size:14px; }
.header button.active{ background:var(--accent); color:#fff; border-color:var(--accent); }
.chart-area{ flex:1; display:flex; flex-direction:column; padding:0 6px 2px 6px; }
#candle{ flex:4; width:100%; }
#volume{ flex:1.2; width:100%; }
.footer{ background:var(--card); border-top:1px solid rgba(255,255,255,.08); padding:6px 10px; }
.legend{ font-size:11px; color:var(--muted); display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:center; }
.dot{ width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px; }
.tooltip{ position:absolute; pointer-events:none; background:rgba(0,0,0,.7); color:#fff; font-size:11px; padding:6px 8px; border-radius:6px; white-space:nowrap; z-index:10; transform:translate(-50%,-120%); }
.hidden{ display:none; }
</style>
</head>
<body class="light">
<div class="wrapper">
  <div class="header">
    <select id="period">
      <option value="7">1ÈÄ±Èñì</option>
      <option value="30" selected>1„É∂Êúà</option>
      <option value="180">ÂçäÂπ¥</option>
      <option value="365">1Âπ¥</option>
    </select>
    <button id="toggle-perc">ÔºÖ</button>
    <button id="toggle-theme">‚òÄÔ∏è</button>
  </div>

  <div class="chart-area" id="chart-wrap">
    <div id="candle"></div>
    <div id="volume"></div>
    <div class="tooltip hidden" id="tooltip"></div>
  </div>

  <!-- ‚Äª‰ª•Ââç„ÅÆ„ÄåSB„Éá„Éº„ÇøÔºã‰∏çË∂≥ÂàÜ‚Ä¶„Äç„É°„ÉÉ„Çª„Éº„Ç∏„ÅØÂâäÈô§ -->
  <div class="footer">
    <div class="legend">
      <span><span class="dot" style="background:#5b9bff"></span>MA5</span>
      <span><span class="dot" style="background:#c084fc"></span>MA25</span>
      <span><span class="dot" style="background:#f6c945"></span>Âá∫Êù•È´ò</span>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL="https://ddtszhkycoqnffgciucl.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkdHN6aGt5Y29xbmZmZ2NpdWNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwMDExODQsImV4cCI6MjA2NDU3NzE4NH0.hASl_SDEf86hISajh9WQ0o5kVTuWZCV7IJ7y363cN9c";

const q=new URLSearchParams(location.search);
const COMPANY=q.get('company')||'KATOJI';
const SRC=(q.get('src')||'fixed').toLowerCase(); // fixed|live
let days=Number(q.get('days')||30);
let priceMode='abs'; // abs|pct
let theme='light';

const since=(d)=>{const s=new Date();s.setDate(s.getDate()-d);return s.toISOString().slice(0,10);}
async function fetchJSON(p){const r=await fetch(`${SUPABASE_URL}${p}`,{headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}}); if(!r.ok) throw new Error(await r.text()); return r.json();}

let candleChart,volChart,candleSeries,volSeries,ma5Series,ma25Series;
function movingAverage(rows,n){ const out=[]; let sum=0,buf=[]; for(const r of rows){ const c=+r.close; buf.push(c); sum+=c; if(buf.length>n) sum-=buf.shift(); out.push({time:r.trade_date,value:buf.length===n?+(sum/n).toFixed(2):NaN}); } return out; }

function draw(rows){
  document.getElementById('chart-wrap').innerHTML=`<div id="candle"></div><div id="volume"></div><div class="tooltip hidden" id="tooltip"></div>`;
  const candleEl=document.getElementById('candle'), volEl=document.getElementById('volume'), tip=document.getElementById('tooltip');
  const cs=getComputedStyle(document.body), bg=cs.getPropertyValue('--bg').trim(), tx=cs.getPropertyValue('--text').trim(), grid=cs.getPropertyValue('--grid').trim();

  candleChart=LightweightCharts.createChart(candleEl,{
    layout:{background:{color:bg},textColor:tx},
    rightPriceScale:{autoScale:true},
    timeScale:{timeVisible:true,borderVisible:false},
    grid:{horzLines:{color:grid},vertLines:{color:grid}},
    handleScroll:{mouseWheel:true,pressedMouseMove:true},
    handleScale:{axisPressedMouseMove:true,pinch:true},
    autoSize:true,
  });
  candleSeries=candleChart.addCandlestickSeries({upColor:'#26a69a',downColor:'#ef5350',borderUpColor:'#26a69a',borderDownColor:'#ef5350',wickUpColor:'#26a69a',wickDownColor:'#ef5350'});

  volChart=LightweightCharts.createChart(volEl,{
    layout:{background:{color:bg},textColor:tx},
    rightPriceScale:{autoScale:true},
    grid:{horzLines:{color:grid},vertLines:{color:grid}},
    timeScale:{visible:true},
    handleScroll:{mouseWheel:true,pressedMouseMove:true},
    handleScale:{axisPressedMouseMove:true,pinch:true},
    autoSize:true
  });
  volSeries=volChart.addHistogramSeries({color:getComputedStyle(document.documentElement).getPropertyValue('--vol').trim(),priceFormat:{type:'volume'}});

  const candles=rows.map(r=>({time:r.trade_date,open:+r.open,high:+r.high,low:+r.low,close:+r.close}));
  const vols=rows.map(r=>({time:r.trade_date,value:+(r.volume||0)}));
  candleSeries.setData(candles); volSeries.setData(vols);

  ma5Series=candleChart.addLineSeries({color:'#5b9bff',lineWidth:2,priceLineVisible:false}); ma5Series.setData(movingAverage(rows,5));
  ma25Series=candleChart.addLineSeries({color:'#c084fc',lineWidth:2,priceLineVisible:false}); ma25Series.setData(movingAverage(rows,25));

  // ‰æ°Ê†ºË°®Á§∫„É¢„Éº„Éâ
  candleChart.priceScale('right').applyOptions({
    mode: priceMode==='pct' ? LightweightCharts.PriceScaleMode.Percentage
                            : LightweightCharts.PriceScaleMode.Normal,
    autoScale:true
  });

  // Ê®™ÂπÖ„ÅÑ„Å£„Å±„ÅÑ
  const N=rows.length; const logical={from:0,to:Math.max(1,N-1)};
  candleChart.timeScale().setVisibleLogicalRange(logical);
  volChart.timeScale().setVisibleLogicalRange(logical);

  // ÂÆåÂÖ®ÂêåÊúü
  let syncing=false;
  function bind(a,b){
    a.timeScale().subscribeVisibleTimeRangeChange(r=>{ if(syncing||!r) return; syncing=true; b.timeScale().setVisibleRange(r); syncing=false; });
    a.timeScale().subscribeVisibleLogicalRangeChange(r=>{ if(syncing||!r) return; syncing=true; b.timeScale().setVisibleLogicalRange(r); syncing=false; });
  }
  bind(candleChart,volChart); bind(volChart,candleChart);

  // tooltip
  candleChart.subscribeCrosshairMove(p=>{
    if(!p||!p.time||!p.point){ tip.classList.add('hidden'); return; }
    const c=p.seriesData.get(candleSeries), m5=p.seriesData.get(ma5Series), m25=p.seriesData.get(ma25Series), v=p.seriesData.get(volSeries);
    if(!c){ tip.classList.add('hidden'); return; }
    tip.classList.remove('hidden');
    tip.innerHTML=`<b>${p.time}</b><br>O:${c.open.toLocaleString()} H:${c.high.toLocaleString()} L:${c.low.toLocaleString()} C:${c.close.toLocaleString()}<br>V:${(v?.value||0).toLocaleString()}„ÄÄ<span style="color:#5b9bff">MA5:${isFinite(m5?.value)?m5.value.toFixed(2):'-'}</span>„ÄÄ<span style="color:#c084fc">MA25:${isFinite(m25?.value)?m25.value.toFixed(2):'-'}</span>`;
    const r=document.getElementById('chart-wrap').getBoundingClientRect(); tip.style.left=`${p.point.x+r.left}px`; tip.style.top=`${p.point.y+r.top}px`;
  });
}

(async function init(){
  // ÊúüÈñì„Çª„É¨„ÇØ„ÇøÂàùÊúüÂÄ§
  const sel=document.getElementById('period');
  if([...sel.options].some(o=>+o.value===days)) sel.value=String(days);

  const sinceStr=since(days);
  const table= SRC==='live' ? 'company_daily_ohlcv_live' : 'company_daily_ohlcv';
  let rows=[];
  try{
    rows=await fetchJSON(`/rest/v1/${table}?company_name=eq.${encodeURIComponent(COMPANY)}&trade_date=gte.${sinceStr}&select=trade_date,open,high,low,close,volume&order=trade_date.asc`);
  }catch(e){ console.error(e); }
  draw(rows);

  // UI
  sel.onchange=(e)=>{ const d=+e.target.value; const u=new URL(location.href); u.searchParams.set('days',d); location.href=u; };
  document.getElementById('toggle-perc').onclick=()=>{
    priceMode = (priceMode==='abs'?'pct':'abs');
    const b=document.getElementById('toggle-perc'); b.classList.toggle('active', priceMode==='pct');
    draw(rows);
  };
  document.getElementById('toggle-theme').onclick=()=>{
    theme=(theme==='light'?'dark':'light');
    document.body.classList.toggle('light');
    const btn=document.getElementById('toggle-theme'); btn.textContent=(theme==='light'?'‚òÄÔ∏è':'üåô');
    draw(rows);
  };
})();
</script>
</body>
</html>
